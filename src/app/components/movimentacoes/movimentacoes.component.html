<mat-toolbar class="subtitulo">Movimentações</mat-toolbar>
<div class="painel-principal" style="padding: 10px;">
    <div class="painel-consultar">
        <form #formulario="ngForm">
            <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="16px" fxFlexFill>

                <div ngModelGroup="comboEmpresa" fxFlex="30%" fxLayoutGap="20px" fxFlexOffset="20px">
                    <combo-pesquisavel #comboEmpresa 
                                       nome="empresa" 
                                       [itens]="empresas" 
                                       itemDescricao="nomeRazaoSocial"
                                       itemId="id"
                                       [showDisplayId]="false" 
                                       [obrigatorio]="false"
                                       placeholder="Informe a empresa..."
                                       [(valor)]="filtro.empresa">
                    </combo-pesquisavel>
                </div>

                <div ngModelGroup="comboPrograma" fxFlex="30%" fxLayoutGap="20px" fxFlexOffset="20px">
                    <combo-pesquisavel #comboPrograma 
                                       nome="programa" 
                                       [itens]="programas" 
                                       itemDescricao="nome"
                                       itemId="id"
                                       [showDisplayId]="false" 
                                       placeholder="Informe o programa..."
                                       [obrigatorio]="false"
                                       [(valor)]="filtro.programa">
                    </combo-pesquisavel>
                </div>

                <div ngModelGroup="comboProjeto" fxFlex="30%" fxLayoutGap="20px" fxFlexOffset="20px">
                    <combo-pesquisavel #comboProjeto 
                                       nome="projeto" 
                                       [itens]="projetos" 
                                       itemDescricao="nome"
                                       itemId="id"
                                       [showDisplayId]="false" 
                                       placeholder="Informe o projeto..."
                                       [obrigatorio]="false"
                                       [(valor)]="filtro.projeto">
                    </combo-pesquisavel>
                </div>
            </div>


            <div fxLayout="row">
                <fieldset sy fxFlex="30%" fxLayoutGap="20px" fxFlexOffset="20px">
                    <legend>Documento</legend>
                    <div fxLayout="row" fxLayoutAlign="center center" fxLayoutGap="16px" 
                         style="height: 67%;">
                        <mat-form-field fxFlex= "120px" >
                            <input matInput name= "dataInicio"
                                   [matDatepicker]="dataInicio" 
                                   placeholder="Data início" 
                                   [(ngModel)]="filtro.dataInicioDoc">
                            <mat-datepicker-toggle matSuffix [for]="dataInicio"></mat-datepicker-toggle>
                            <mat-datepicker #dataInicio></mat-datepicker>
                        </mat-form-field>
                    
                        <mat-form-field fxFlex= "120px" >
                            <input matInput name= "dataFim"
                                   [matDatepicker]="dataFim" 
                                   [min]="filtro.dataInicioDoc"
                                   placeholder="Data fim" 
                                   [(ngModel)]="filtro.dataFimDoc">
                            <mat-datepicker-toggle matSuffix [for]="dataFim"></mat-datepicker-toggle>
                            <mat-datepicker #dataFim></mat-datepicker>

                            <mat-error>Não pode ser inferior a data de início</mat-error>
                        </mat-form-field>

                        <mat-form-field fxFlex= "120px" fxFlexOffset="20px">
                            <input [(ngModel)]="filtro.numeroDocumento"
                                   name="numeroDocumento"
                                   placeholder="Número"
                                   matInput maxlength="20"
                                   />
                        </mat-form-field>
                    </div>  
                </fieldset> 

                <fieldset sy fxFlex="30%" fxLayoutGap="20px" fxFlexOffset="20px">
                    <legend>Movimento</legend>
                    <div fxLayout="row" fxLayoutAlign="center center" fxLayoutGap="16px" 
                         style="height: 67%;">
                        <mat-form-field fxFlex= "120px" >
                            <input matInput name= "dataInicioMov"
                                   [matDatepicker]="dataInicioMov" 
                                   placeholder="Data início" 
                                   [(ngModel)]="filtro.dataInicioMov">
                            <mat-datepicker-toggle matSuffix [for]="dataInicioMov"></mat-datepicker-toggle>
                            <mat-datepicker #dataInicioMov></mat-datepicker>
                        </mat-form-field>
                    
                        <mat-form-field fxFlex= "120px" >
                            <input matInput name= "dataFimMov"
                                   [matDatepicker]="dataFimMov" 
                                   [min]="filtro.dataFimMov"
                                   placeholder="Data fim" 
                                   [(ngModel)]="filtro.dataFimMov">
                            <mat-datepicker-toggle matSuffix [for]="dataFimMov"></mat-datepicker-toggle>
                            <mat-datepicker #dataFimMov></mat-datepicker>

                            <mat-error>Não pode ser inferior a data de início</mat-error>
                        </mat-form-field>

                        <mat-form-field fxFlex= "120px" fxFlexOffset="20px">
                            <input [(ngModel)]="filtro.valor"
                                   currencyMask 
                                   name="valor"
                                   placeholder="Valor"
                                   matInput 
                                   maxlength="13"
                                   [options]="{ prefix: '', thousands: '.', decimal: ',' }" />
                            <span matPrefix>R$&nbsp;</span>
                        </mat-form-field>

                    </div>  
                </fieldset> 

                
                <fieldset fxFlex="30%" fxLayoutGap="20px" fxFlexOffset="20px">
                    <legend>Vencimento</legend>
                    <div fxLayout="row" fxLayoutAlign="center center" fxLayoutGap="16px" style="height: 67%;">
                        <mat-form-field fxFlex= "160px" >
                            <input matInput name= "dataVencimento"
                                   [matDatepicker]="dataVencimento" 
                                   placeholder="Data vencimento" 
                                   [(ngModel)]="filtro.dataVencimento">
                            <mat-datepicker-toggle matSuffix [for]="dataVencimento"></mat-datepicker-toggle>
                            <mat-datepicker #dataVencimento></mat-datepicker>
                        </mat-form-field>
                    </div>  
                </fieldset> 
            </div>

            <div dir="rtl" class="botoes" fxLayoutGap="20px" style="padding-top: 20px; padding-bottom: 20px;"
                fxFlexFill>

                <button mat-raised-button fxFlex="20%" (click)="consultar()" [disabled]="formulario.invalid">
                    CONSULTAR
                </button>

                <button mat-raised-button fxFlex="20%" style="padding-right: 20px" (click)="limpar()" route>
                    LIMPAR
                </button>

            </div>
        </form>

        <div [hidden]="!mostrarTabela" style="margin-top: 20px;">
            <mat-paginator #paginator [pageSizeOptions]="[2, 5,30, 60, 90, 150]" showFirstLastButtons></mat-paginator>
        </div>
        <table *ngIf="mostrarTabela; else tabelaSemDados" mat-table [dataSource]="dataSource">

            <ng-container matColumnDef="programaprojeto">
                <th mat-header-cell *matHeaderCellDef style="width: 25%"> Projeto/Programa </th>
                <td mat-cell *matCellDef="let element"> 
                    <projeto-programa-cell [rateios]="element.rateios"></projeto-programa-cell>                 
                </td>
            </ng-container>
            
            <ng-container matColumnDef="empresa">
                <th mat-header-cell *matHeaderCellDef style="width: 22%"> Empresa </th>
                <td mat-cell *matCellDef="let element"> 
                    {{element.empresa?.nomeRazaoSocial.toUpperCase()}}                    
                </td>
            </ng-container>

            <ng-container matColumnDef="dataDocumento">
                <th mat-header-cell *matHeaderCellDef style="width: 10%"> Data Documento </th>
                <td mat-cell *matCellDef="let element"> {{ element.dataDocumento | dataSimples }} </td>
            </ng-container>

            <ng-container matColumnDef="valorUltimoPagamento">
                <th mat-header-cell *matHeaderCellDef style="width: 8%"> Último Pag.</th>
                <td mat-cell *matCellDef="let element"> 
                    {{getUltimoPagamento(element) | currency: 'BRL'  }}
                </td>
            </ng-container>
           
            <ng-container matColumnDef="valorMovimentacao">
                <th mat-header-cell *matHeaderCellDef style="width: 10%"> Valor Movimento </th>
                <td mat-cell *matCellDef="let element"> {{ element.valorMovimentacao | currency: 'BRL' }} </td>
            </ng-container>

            <ng-container matColumnDef="dataMovimento">
                <th mat-header-cell *matHeaderCellDef style="width: 8%"> Data Movimento </th>
                <td mat-cell *matCellDef="let element"> {{ element.dataMovimentacao | dataSimples }} </td>
            </ng-container>            

            <ng-container matColumnDef="nrDocumento">
                <th mat-header-cell *matHeaderCellDef style="width: 8%"> Nº Documento</th>
                <td mat-cell *matCellDef="let element"> {{ element.nrDocumento }} </td>
            </ng-container>

            <ng-container matColumnDef="acoes">
                <th mat-header-cell *matHeaderCellDef style="width: 8%"> Ações </th>
                <td mat-cell *matCellDef="let element">
                    <button *ngIf="perfilAcesso.deleta"  mat-button (click)="deletar(element)" style="min-width: auto; padding: 0px">
                        <mat-icon>delete</mat-icon>
                    </button>
                    <button *ngIf="perfilAcesso.consulta" mat-button (click)="atualizar(element)" style="min-width: auto;">
                        <mat-icon>search</mat-icon>
                    </button>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
        <div [hidden]="!mostrarTabela">
            <mat-paginator (page)="handlePageBottom($event)" 
                           [pageSize]="paginator.pageSize"
                           [pageIndex]="paginator.pageIndex" 
                           [length]="paginator.length"
                           [pageSizeOptions]="paginator.pageSizeOptions">
            </mat-paginator>
        </div>
        
        <ng-template #tabelaSemDados >
            <div fxLayout="row" fxLayoutAlign="center center" style="padding-top: 20px">
                {{msg}}
            </div>
        </ng-template>

        <div fxLayout="row"  *ngIf="perfilAcesso.insere" fxLayoutAlign="end center" fxLayoutGap="16px"
            style="padding-top: 50px">
            <div>
                <button matTooltip="Adicionar nova movimentação" mat-fab color="primary" [routerLink]="['/movimentacoes/cadastrar']"
                    routerLinkActive="router-link-active">
                    <mat-icon>add</mat-icon>
                </button>
            </div>
        </div>
    </div>
</div>